{% extends 'base.html' %}
{% block content %}

{% block title %}{{ giveaway.title }}{% endblock %}

{% load static %}
<link rel="stylesheet" href="{% static 'css/giveaway_detailpage.css' %}">
<div class="giveaway-container mb-4">
    <!-- Header Image -->
    <div class="image-event-box">
      {% if giveaway.image %}
        <img class="header-image" src="{{ giveaway.image.url }}" id="prize-image" alt="Premiebilde">
      {% else %}
        <img class="header-image" src="{% static 'img/default_giveaway.png' %}" id="prize-image" alt="Premiebilde">
      {% endif %}
    </div>
    <!-- Host Organizer Card -->
    <div class="profile-card card shadow-sm border-1">
      <div class="d-flex align-items-center">
        {% if business.logo %}
          <img src="{{ business.logo.url }}" class="host-logo-rounded rounded-circle" alt="{{ business.name }} logo">
        {% endif %}
        <div class="flex-grow-1">
          <div class="host-name">{{ business.name }}</div>
          <small class="text-muted">{{ business.city }}{% if business.postal_code %}, {{ business.postal_code }}{% endif %}</small>
        </div>
      </div>
    </div>
    <!-- Event Tags -->
    <section class="event-tags">
      <span class="tags-category">üéÅ Giveaway</span>
      <span class="tags-location">üìç {{ business.city }}{% if business.postal_code %}, {{ business.postal_code }}{% endif %}</span>
    </section>
    <!-- Event Title -->
    <section>
      <h1 class="h1">{{ giveaway.title }}</h1>
    </section>
    <!-- Accordion -->
    <div class="accordion">
      <details>
        <summary>üîê Competition Info</summary>
        <p><strong>Organizer:</strong> {{ business.name }}</p>
        <p><strong>Status:</strong> {% if giveaway.is_active %}‚úÖ Active{% else %}‚ùå Not active{% endif %}</p>
        <p><strong>Created:</strong> {{ giveaway.created_at|date:"d. M Y H:i" }}</p>
      </details>
    </div>
    <!-- Event Details -->
    <section class="details-box">
      <div class="event-details">
        <div class="info-row"><span class="h2">Premie</span></div>
        <div class="info-row"><span class="highlight">Verdi:</span><span>{{ giveaway.prize_value|default:'?' }} NOK</span></div>
        <div class="info-row"><span>Trekningsdato:</span><span>{{ giveaway.end_date|date:"d. M Y H:i" }}</span></div>
        <div class="info-row"><span>Antall p√•meldte:</span><span class="highlight">{{ entries_count }}</span></div>
        <div class="info-row"><span>Antall vinnere:</span><span class="highlight">1</span></div>
      </div>
    </section>
    <!-- Event Description -->
    <section class="details-box">
      <div class="event-details">
        <div class="info-row"><span class="h2">Beskrivelse</span></div>
        <p class="paragraph">{{ giveaway.description }}</p>
      </div>
    </section>
    <!-- How to join -->
    <section class="details-box">
      <span class="h2">How to Participate?</span>
      {% if messages %}
        {% for message in messages %}
          <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">{{ message }}</div>
        {% endfor %}
      {% endif %}
      {% if not request.user.is_authenticated %}
        <div class="alert alert-warning text-center my-4">
          <strong>You must be logged in as a member to participate in this giveaway.</strong><br>
          <a class="btn btn-primary mt-3" href="{% url 'accounts:member-login' %}?next={{ request.path }}">Log in or register</a>
        </div>
      {% elif is_member %}
        {% if has_joined %}
          <div class="alert alert-success text-center my-4">
            <strong>You are registered!</strong>
          </div>
          <button class="btn btn-success w-100" disabled>Registered</button>
        {% elif can_participate and entry_form %}
          <form method="post" class="mt-3" id="entry-form">
            {% csrf_token %}
            {% if giveaway.signup_question %}
              <h4>{{ giveaway.signup_question }}</h4>
            {% endif %}
            {{ entry_form.answer.errors }}
            {{ entry_form.user_location_city }}
            <div class="mb-3">
              <div class="alert alert-info">
                <i class="bi bi-geo-alt"></i> Your registered location: <strong>{{ request.user.city }}</strong>
                <small class="d-block mt-1">Note: Your registered location must match the business location ({{ business.city }}) to participate.</small>
              </div>
            </div>
            {% for radio in entry_form.answer %}
              <div class="form-check mt-3 my-1 mx-4">
                {{ radio.tag }}
                <label class="form-check-label" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
              </div>
            {% endfor %}
            <div class="giveaway-submit text-center my-4 mx-4">
              <button class="btn btn-primary" type="submit">Participate for free</button>
            </div>

            {% if entry_form.non_field_errors %}
              <div class="alert alert-danger">{{ entry_form.non_field_errors }}</div>
            {% endif %}
          </form>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              // Get current user city from profile
              const userProfileCity = "{{ request.user.city|default:'' }}";
              const businessCity = "{{ business.city }}";
              
              // Only use geolocation if user hasn't set a city in their profile
              // or if their current city doesn't match the business city
              const shouldUseGeolocation = !userProfileCity || 
                                         userProfileCity.toLowerCase() !== businessCity.toLowerCase();
              
              if (shouldUseGeolocation && navigator.geolocation) {
                // Display a message that we're checking their location
                const locationInfo = document.querySelector('.alert-info');
                if (locationInfo) {
                  locationInfo.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"></div> Checking your location...';
                }
                
                navigator.geolocation.getCurrentPosition(function(position) {
                  const lat = position.coords.latitude;
                  const lon = position.coords.longitude;
                  
                  // Use OpenStreetMap Nominatim for reverse geocoding
                  fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=en`)
                    .then(response => response.json())
                    .then(data => {
                      // Get city from the response data
                      let city = data.address.city || data.address.town || data.address.village || data.address.hamlet || data.address.municipality;
                      if (!city && data.address.county) city = data.address.county;
                      
                      if (city) {
                        // Check if the detected city matches profile city
                        if (userProfileCity && userProfileCity.toLowerCase() === city.toLowerCase()) {
                          // No need to update if they match
                          if (locationInfo) {
                            locationInfo.innerHTML = `<i class="bi bi-geo-alt"></i> Your registered location: <strong>${userProfileCity}</strong><small class="d-block mt-1">Note: Your registered location must match the business location (${businessCity}) to participate.</small>`;
                          }
                          return;
                        }
                        
                        // Don't update if user already set their city in profile
                        if (userProfileCity) {
                          if (locationInfo) {
                            locationInfo.innerHTML = `<i class="bi bi-geo-alt"></i> Your registered location: <strong>${userProfileCity}</strong><small class="d-block mt-1">Note: Your registered location must match the business location (${businessCity}) to participate.</small>`;
                          }
                          return;
                        }
                        
                        // Update only if user hasn't set their city
                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        fetch('/accounts/update-location/', {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                          },
                          body: JSON.stringify({
                            city: city
                          })
                        }).then(response => response.json())
                          .then(data => {
                            if (data.success) {
                              // Update the UI to show the user's updated location
                              if (locationInfo) {
                                locationInfo.innerHTML = `<i class="bi bi-geo-alt"></i> Your location detected: <strong>${city}</strong> <span class="badge text-bg-success">Updated</span><small class="d-block mt-1">Note: Your location must match the business location (${businessCity}) to participate.</small>`;
                              }
                              
                              // Check if the location matches the business city
                              if (city.toLowerCase() === businessCity.toLowerCase()) {
                                // Reload the page to reflect the updated status
                                setTimeout(() => location.reload(), 1500);
                              }
                            }
                          })
                          .catch(error => console.error('Error updating location:', error));
                      }
                    })
                    .catch(error => console.error('Error during reverse geocoding:', error));
                }, function(error) {
                  console.error('Geolocation error:', error);
                  // Show the user's profile city if geolocation fails
                  const locationInfo = document.querySelector('.alert-info');
                  if (locationInfo && userProfileCity) {
                    locationInfo.innerHTML = `<i class="bi bi-geo-alt"></i> Your registered location: <strong>${userProfileCity}</strong><small class="d-block mt-1">Note: Your registered location must match the business location (${businessCity}) to participate.</small>`;
                  }
                }, {
                  // Geolocation options
                  enableHighAccuracy: true,
                  timeout: 10000,
                  maximumAge: 0
                });
              }
            });
          </script>
        {% else %}
          <div class="alert alert-info">This giveaway is not currently active for registration.</div>
        {% endif %}
      {% elif is_business %}
        <div class="alert alert-info text-center my-4">
          <strong>Only members can participate in giveaways.</strong><br>
          <span>You are logged in as a business user and cannot participate.</span>
        </div>
      {% else %}
        <div class="alert alert-warning text-center my-4">
          <strong>Only members can participate in giveaways.</strong><br>
          <span>You must be a member to participate.</span>
        </div>
        </div>
      {% endif %}
      <p class="paragraph text-center mt-4">By participating you accept Railbird AS's terms of service</p>
      <a class="btn secondary" href="#">Railbird Competition Rules</a>
    </section>
</div>
{% endblock %}
