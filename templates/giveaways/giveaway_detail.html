{% extends 'base.html' %}
{% block content %}

{% block title %}{{ giveaway.title }}{% endblock %}

{% load static %}
<link rel="stylesheet" href="{% static 'css/giveaway_detailpage.css' %}">
<div class="giveaway-container mb-4">
    <!-- Header Image -->
    <div class="image-event-box">
      {% if giveaway.image %}
        <img class="header-image" src="{{ giveaway.image.url }}" id="prize-image" alt="Premiebilde">
      {% else %}
        <img class="header-image" src="{% static 'img/default_giveaway.png' %}" id="prize-image" alt="Premiebilde">
      {% endif %}
    </div>
    <!-- Host Organizer Card -->
    <div class="profile-card card shadow-sm border-1">
      <div class="d-flex align-items-center">
        {% if business.logo %}
          <img src="{{ business.logo.url }}" class="host-logo-rounded rounded-circle" alt="{{ business.name }} logo">
        {% endif %}
        <div class="flex-grow-1">
          <div class="host-name">{{ business.name }}</div>
          <small class="text-muted">{{ business.city }}{% if business.postal_code %}, {{ business.postal_code }}{% endif %}</small>
        </div>
      </div>
    </div>
    <!-- Event Tags -->
    <section class="event-tags">
      <span class="tags-category">üéÅ Giveaway</span>
      <span class="tags-location">üìç {{ business.city }}{% if business.postal_code %}, {{ business.postal_code }}{% endif %}</span>
    </section>
    <!-- Event Title -->
    <section>
      <h1 class="h1">{{ giveaway.title }}</h1>
    </section>
    <!-- Accordion -->
    <div class="accordion">
      <details>
        <summary>üîê Competition Info</summary>
        <p><strong>Organizer:</strong> {{ business.name }}</p>
        <p><strong>Status:</strong> {% if giveaway.is_active %}‚úÖ Active{% else %}‚ùå Not active{% endif %}</p>
        <p><strong>Created:</strong> {{ giveaway.created_at|date:"d. M Y H:i" }}</p>
      </details>
    </div>
    <!-- Event Details -->
    <section class="details-box">
      <div class="event-details">
        <div class="info-row"><span class="h2">Premie</span></div>
        <div class="info-row"><span class="highlight">Verdi:</span><span>{{ giveaway.prize_value|default:'?' }} NOK</span></div>
        <div class="info-row"><span>Trekningsdato:</span><span>{{ giveaway.end_date|date:"d. M Y H:i" }}</span></div>
        <div class="info-row"><span>Antall p√•meldte:</span><span class="highlight">{{ entries_count }}</span></div>
        <div class="info-row"><span>Antall vinnere:</span><span class="highlight">1</span></div>
      </div>
    </section>
    <!-- Event Description -->
    <section class="details-box">
      <div class="event-details">
        <div class="info-row"><span class="h2">Beskrivelse</span></div>
        <p class="paragraph">{{ giveaway.description }}</p>
      </div>
    </section>
    <!-- How to join -->
    <section class="details-box">
      <span class="h2">How to Participate?</span>
      {% if messages %}
        {% for message in messages %}
          <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">{{ message }}</div>
        {% endfor %}
      {% endif %}
      {% if not request.user.is_authenticated %}
        <div class="alert alert-warning text-center my-4">
          <strong>You must be logged in as a member to participate in this giveaway.</strong><br>
          <a class="btn btn-primary mt-3" href="/login/?next={{ request.path }}">Log in or register</a>
        </div>
      {% elif is_member %}
        {% if has_joined %}
          <div class="alert alert-success text-center my-4">
            <strong>You are registered!</strong>
          </div>
          <button class="btn btn-success w-100" disabled>Registered</button>
        {% elif can_participate and entry_form %}
          <form method="post" class="mt-3" id="entry-form">
            {% csrf_token %}
            {% if giveaway.signup_question %}
              <h4>{{ giveaway.signup_question }}</h4>
            {% endif %}
            {{ entry_form.answer.errors }}
            <div class="mb-3">
              <label for="id_user_location_city" class="form-label">Your city <span class="text-danger">*</span></label>
              {{ entry_form.user_location_city }}
              <small class="form-text text-muted">Your city must match the business location ({{ business.city }}) to participate.</small>
              <div class="mt-2 d-grid">
                <button type="button" id="use-my-location" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-geo-alt"></i> Use my current location
                </button>
              </div>
              <div id="location-status" class="mt-2 small d-none alert"></div>
            </div>
            {% for radio in entry_form.answer %}
              <div class="form-check mt-3 my-1 mx-4">
                {{ radio.tag }}
                <label class="form-check-label" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
              </div>
            {% endfor %}
            <div class="giveaway-submit text-center my-4 mx-4">
              <button class="btn btn-primary" type="submit">Participate for free</button>
            </div>

            {% if entry_form.non_field_errors %}
              <div class="alert alert-danger">{{ entry_form.non_field_errors }}</div>
            {% endif %}
          </form>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const locationButton = document.getElementById('use-my-location');
              const cityField = document.getElementById('id_user_location_city');
              const statusDiv = document.getElementById('location-status');
              const businessCity = "{{ business.city }}";
              
              // Function to update status message
              function updateStatus(message, type) {
                statusDiv.textContent = message;
                statusDiv.className = `mt-2 small alert alert-${type}`;
                statusDiv.classList.remove('d-none');
              }
              
              // Get location when button is clicked
              if (locationButton) {
                locationButton.addEventListener('click', function() {
                  statusDiv.classList.remove('d-none');
                  statusDiv.className = 'mt-2 small alert alert-info';
                  statusDiv.textContent = 'Henter din posisjon...';
                  
                  if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                      const lat = position.coords.latitude;
                      const lon = position.coords.longitude;
                      
                      // Use OpenStreetMap Nominatim for reverse geocoding
                      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=no`)
                        .then(response => response.json())
                        .then(data => {
                          let city = data.address.city || data.address.town || data.address.village || data.address.hamlet || data.address.municipality;
                          if (!city && data.address.county) city = data.address.county;
                          
                          // Update city field
                          if (cityField) {
                            cityField.value = city;
                            
                            // Check if location matches business city
                            if (city.toLowerCase() === businessCity.toLowerCase()) {
                              updateStatus(`Din posisjon (${city}) matcher bedriftens lokasjon!`, 'success');
                            } else {
                              updateStatus(`Merk: Din posisjon (${city}) er ikke i samme by som bedriften (${businessCity}). Du m√• v√¶re i ${businessCity} for √• delta.`, 'warning');
                            }
                          }
                        })
                        .catch(error => {
                          console.error('Error during reverse geocoding:', error);
                          updateStatus('Kunne ikke bestemme byposisjon fra koordinater.', 'danger');
                        });
                    }, function(error) {
                      // Handle geolocation errors
                      let errorMsg = 'Kunne ikke hente din posisjon.';
                      if (error.code === error.PERMISSION_DENIED) {
                        errorMsg = 'Du m√• tillate posisjonsdeling i nettleseren for √• bruke denne funksjonen.';
                      }
                      updateStatus(errorMsg, 'danger');
                    }, {
                      // Geolocation options
                      enableHighAccuracy: true,
                      timeout: 10000,
                      maximumAge: 0
                    });
                  } else {
                    updateStatus('Nettleseren din st√∏tter ikke geolokasjon.', 'danger');
                  }
                });
              }
            });
          </script>
        {% else %}
          <div class="alert alert-info">Denne giveawayen er ikke aktiv for p√•melding.</div>
        {% endif %}
      {% elif is_business %}
        <div class="alert alert-info text-center my-4">
          <strong>Bare medlemmer kan delta i giveaways.</strong><br>
          <span>Du er innlogget som bedriftsbruker og kan ikke delta.</span>
        </div>
      {% else %}
        <div class="alert alert-warning text-center my-4">
          <strong>Bare medlemmer kan delta i giveaways.</strong><br>
          <span>Du m√• v√¶re medlem for √• delta.</span>
        </div>
        </div>
      {% endif %}
      <p class="paragraph text-center mt-4">N√•r du deltar godkjenner du Railbird AS sine brukervilk√•r</p>
      <a class="btn secondary" href="#">Railbird konkurranseregler</a>
    </section>
</div>
{% endblock %}
