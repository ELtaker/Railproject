<!DOCTYPE html>
{% load static %}
<link rel="stylesheet" href="{% static 'css/giveaway_detailpage.css' %}">
<div class="giveaway-container mb-4">
    <!-- Header Image -->
    <div class="image-event-box">
      {% if giveaway.image %}
        <img class="header-image" src="{{ giveaway.image.url }}" id="prize-image" alt="Premiebilde">
      {% else %}
        <img class="header-image" src="{% static 'img/default_giveaway.png' %}" id="prize-image" alt="Premiebilde">
      {% endif %}
    </div>
    <!-- Host Organizer Card -->
    <div class="profile-card card shadow-sm border-1">
      <div class="d-flex align-items-center">
        {% if business.logo %}
          <img src="{{ business.logo.url }}" class="host-logo-rounded rounded-circle" alt="{{ business.name }} logo">
        {% endif %}
        <div class="flex-grow-1">
          <div class="host-name">{{ business.name }}</div>
          <small class="text-muted">{{ business.city }}{% if business.postal_code %}, {{ business.postal_code }}{% endif %}</small>
        </div>
      </div>
    </div>
    <!-- Event Tags -->
    <section class="event-tags">
      <span class="tags-category">üéÅ Giveaway</span>
      <span class="tags-location">üìç {{ business.city }}{% if business.postal_code %}, {{ business.postal_code }}{% endif %}</span>
    </section>
    <!-- Event Title -->
    <section>
      <h1 class="h1">{{ giveaway.title }}</h1>
    </section>
    <!-- Accordion -->
    <div class="accordion">
      <details>
        <summary>üîê Konkurranseinfo</summary>
        <p><strong>Arrang√∏r:</strong> {{ business.name }}</p>
        <p><strong>Status:</strong> {% if giveaway.is_active %}‚úÖ Aktiv{% else %}‚ùå Ikke aktiv{% endif %}</p>
        <p><strong>Opprettet:</strong> {{ giveaway.created_at|date:"d. M Y H:i" }}</p>
      </details>
    </div>
    <!-- Event Details -->
    <section class="details-box">
      <div class="event-details">
        <div class="info-row"><span class="h2">Premie</span></div>
        <div class="info-row"><span class="highlight">Verdi:</span><span>{{ giveaway.prize_value|default:'?' }} NOK</span></div>
        <div class="info-row"><span>Trekningsdato:</span><span>{{ giveaway.end_date|date:"d. M Y H:i" }}</span></div>
        <div class="info-row"><span>Antall p√•meldte:</span><span class="highlight">{{ entries_count }}</span></div>
        <div class="info-row"><span>Antall vinnere:</span><span class="highlight">1</span></div>
      </div>
    </section>
    <!-- Event Description -->
    <section class="details-box">
      <div class="event-details">
        <div class="info-row"><span class="h2">Beskrivelse</span></div>
        <p class="paragraph">{{ giveaway.description }}</p>
      </div>
    </section>
    <!-- How to join -->
    <section class="details-box">
      <span class="h2">Hvordan delta?</span>
      {% if messages %}
        {% for message in messages %}
          <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">{{ message }}</div>
        {% endfor %}
      {% endif %}
      {% if not request.user.is_authenticated %}
        <div class="alert alert-warning text-center my-4">
          <strong>Du m√• v√¶re innlogget som medlem for √• delta i denne giveawayen.</strong><br>
          <a class="btn btn-primary mt-3" href="/login/?next={{ request.path }}">Logg inn eller registrer deg</a>
        </div>
      {% elif is_member %}
        {% if has_joined %}
          <div class="alert alert-success text-center my-4">
            <strong>Du er p√•meldt!</strong>
          </div>
          <button class="btn btn-success w-100" disabled>P√•meldt</button>
        {% elif kan_delta and entry_form %}
          <form method="post" class="mt-3" id="entry-form">
            {% csrf_token %}
            {% if giveaway.signup_question %}
              <h4>{{ giveaway.signup_question }}</h4>
            {% endif %}
            {{ entry_form.answer.errors }}
            {{ entry_form.user_location_city }}
            {% for radio in entry_form.answer %}
              <div class="form-check mt-3 my-1 mx-4">
                {{ radio.tag }}
                <label class="form-check-label" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
              </div>
            {% endfor %}
            <div class="giveaway-submit text-center my-4 mx-4">
              <button class="btn btn-primary" type="submit">Delta gratis</button>
            </div>
            <input type="hidden" name="user_location_city" id="id_user_location_city">
            {% if entry_form.non_field_errors %}
              <div class="alert alert-danger">{{ entry_form.non_field_errors }}</div>
            {% endif %}
          </form>
          <script>
            // Geolokasjon og reverse-geocoding (OpenStreetMap Nominatim)
            document.addEventListener('DOMContentLoaded', function() {
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                  const lat = position.coords.latitude;
                  const lon = position.coords.longitude;
                  fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=no`)
                    .then(response => response.json())
                    .then(data => {
                      let city = data.address.city || data.address.town || data.address.village || data.address.hamlet || data.address.municipality;
                      if (!city && data.address.county) city = data.address.county;
                      const cityField = document.querySelector('input[name="user_location_city"]');
                      if (cityField) cityField.value = city;
                    });
                });
              }
            });
          </script>
        {% else %}
          <div class="alert alert-info">Denne giveawayen er ikke aktiv for p√•melding.</div>
        {% endif %}
      {% elif is_business %}
        <div class="alert alert-info text-center my-4">
          <strong>Bare medlemmer kan delta i giveaways.</strong><br>
          <span>Du er innlogget som bedriftsbruker og kan ikke delta.</span>
        </div>
      {% else %}
        <div class="alert alert-warning text-center my-4">
          <strong>Bare medlemmer kan delta i giveaways.</strong><br>
          <span>Du m√• v√¶re medlem for √• delta.</span>
        </div>
        </div>
      {% else %}
        <div class="alert alert-info">Denne giveawayen er ikke aktiv for p√•melding.</div>
      {% endif %}
      <p class="paragraph text-center mt-4">N√•r du deltar godkjenner du Railbird AS sine brukervilk√•r</p>
      <a class="btn secondary" href="#">Railbird konkurranseregler</a>
    </section>
</div>
